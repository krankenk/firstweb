<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Configuration - REPLACE WITH YOUR PUBLISHED SHEET URL
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSrUN6ae5dxAA1CgmfuERDNXLRgfT7-sv0WTkfySczfdMuh_mL-0Eyy3HIn1dwGR2-H2iI2WABYE6Gq/pub?gid=1516526594&single=true&output=csv';
        
        // 2. Data Storage
        let dashboardData = {};
        let charts = {}; // Store chart instances
        
        // 3. Main Data Fetching Function
        function fetchData() {
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        dashboardData = results.data[0];
                        updateDashboard();
                        updateCharts();
                    }
                },
                error: function(error) {
                    console.error("Error fetching data:", error);
                    useFallbackData();
                }
            });
        }
        
        // 4. Fallback Data
        function useFallbackData() {
            dashboardData = {
                sebalang1_output: "85.2",
                sebalang1_status: "Online",
                sebalang2_output: "0",
                sebalang2_status: "Offline",
                pltg_output: "0",
                pltg_status: "Maintenance",
                weekly_efor: "2.3",
                weekly_eaf: "94.2",
                weekly_nphr: "9245",
                weekly_sfc: "0.24",
                co_firing_rate: "15.2",
                green_mwh_last_week: "1250",
                green_mwh_current_week: "1380",
                sdof: "1.8",
                problem_sebalang1_desc: "Boiler feed pump vibration",
                problem_sebalang1_severity: "High",
                problem_pltg_desc: "Scheduled maintenance",
                problem_pltg_severity: "Medium",
                problem_sebalang2_desc: "Normal operation",
                problem_sebalang2_severity: "Low",
                production_week1: "580",
                production_week2: "620",
                production_week3: "595",
                production_week4: "640",
                production_week5: "610",
                production_week6: "655",
                production_week7: "625",
                production_week8: "670",
                ncf_last_year: "78",
                ncf_current_year: "80",
                eaf_monthly: "92",
                efor_monthly: "3.2",
                timestamp: new Date().toISOString()
            };
            updateDashboard();
            updateCharts();
        }
        
        // 5. Dashboard Update Functions
        function updateDashboard() {
            updateTimestamp();
            updatePlantCards();
            updateKPIMetrics();
            updateProblemSections();
            updateCoFiringSection();
        }
        
        function updateTimestamp() {
            const now = dashboardData.timestamp ? new Date(dashboardData.timestamp) : new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }
        
        function updatePlantCards() {
            // Sebalang #1 Card (Green)
            const card1 = document.querySelector('.border-green-500');
            if (card1) {
                card1.querySelector('.text-3xl').textContent = dashboardData.sebalang1_output + ' MW';
                updateStatusIndicator(card1, dashboardData.sebalang1_status);
            }
            
            // Sebalang #2 Card (Blue)
            const card2 = document.querySelector('.border-blue-500');
            if (card2) {
                card2.querySelector('.text-3xl').textContent = dashboardData.sebalang2_output + ' MW';
                updateStatusIndicator(card2, dashboardData.sebalang2_status);
            }
            
            // PLTG Card (Yellow)
            const card3 = document.querySelector('.border-yellow-500');
            if (card3) {
                card3.querySelector('.text-3xl').textContent = dashboardData.pltg_output + ' MW';
                updateStatusIndicator(card3, dashboardData.pltg_status);
            }
        }
        
        function updateStatusIndicator(card, status) {
            const statusElement = card.querySelector('[class*="status-"]');
            const statusText = card.querySelector('.mt-4 .text-sm');
            const pulseDot = card.querySelector('.w-2.h-2');
            
            // Reset classes
            statusElement.className = 'text-white p-3 rounded-full';
            pulseDot.className = 'w-2 h-2 rounded-full pulse-animation mr-2';
            statusText.className = 'text-sm font-medium';
            
            // Set new status
            if (status === 'Online') {
                statusElement.classList.add('status-online');
                pulseDot.classList.add('bg-green-500');
                statusText.classList.add('text-green-600');
                statusElement.innerHTML = '<i class="fas fa-power-off text-xl"></i>';
            } else if (status === 'Maintenance') {
                statusElement.classList.add('status-maintenance');
                pulseDot.classList.add('bg-yellow-500');
                statusText.classList.add('text-yellow-600');
                statusElement.innerHTML = '<i class="fas fa-tools text-xl"></i>';
            } else {
                statusElement.classList.add('status-offline');
                pulseDot.classList.add('bg-red-500');
                statusText.classList.add('text-red-600');
                statusElement.innerHTML = '<i class="fas fa-power-off text-xl"></i>';
            }
            statusText.textContent = status;
        }
        
        function updateKPIMetrics() {
            // EFOR Card
            document.querySelectorAll('.bg-white.rounded-xl.card-shadow')[0]
                .querySelector('.text-2xl').textContent = dashboardData.weekly_efor + '%';
            
            // EAF Card
            document.querySelectorAll('.bg-white.rounded-xl.card-shadow')[1]
                .querySelector('.text-2xl').textContent = dashboardData.weekly_eaf + '%';
            
            // NPHR Card
            document.querySelectorAll('.bg-white.rounded-xl.card-shadow')[2]
                .querySelector('.text-2xl').textContent = dashboardData.weekly_nphr;
            
            // SFC Card
            document.querySelectorAll('.bg-white.rounded-xl.card-shadow')[3]
                .querySelector('.text-2xl').textContent = dashboardData.weekly_sfc;
        }
        
        function updateProblemSections() {
            // Sebalang #1 Problem
            updateProblem(
                'Sebalang #1',
                dashboardData.problem_sebalang1_desc,
                dashboardData.problem_sebalang1_severity
            );
            
            // PLTG Problem
            updateProblem(
                'PLTG',
                dashboardData.problem_pltg_desc,
                dashboardData.problem_pltg_severity
            );
            
            // Sebalang #2 Problem
            updateProblem(
                'Sebalang #2',
                dashboardData.problem_sebalang2_desc,
                dashboardData.problem_sebalang2_severity
            );
        }
        
        function updateProblem(plant, description, severity) {
            const problemsContainer = document.querySelector('.grid.grid-cols-1.lg\\:grid-cols-2.gap-6');
            if (!problemsContainer) return;
            
            const problems = problemsContainer.querySelectorAll('.flex.items-center.justify-between');
            
            problems.forEach(problem => {
                if (problem.querySelector('.font-semibold').textContent.includes(plant)) {
                    // Update problem description
                    problem.querySelector('.text-sm').textContent = description;
                    
                    // Update severity
                    const badge = problem.querySelector('span');
                    badge.textContent = severity;
                    
                    // Update colors based on severity
                    if (severity === 'High') {
                        problem.className = 'flex items-center justify-between p-4 bg-red-50 rounded-lg border-l-4 border-red-500';
                        problem.querySelector('.text-sm').className = 'text-sm text-red-600';
                        badge.className = 'px-3 py-1 bg-red-200 text-red-800 rounded-full text-sm';
                    } else if (severity === 'Medium') {
                        problem.className = 'flex items-center justify-between p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500';
                        problem.querySelector('.text-sm').className = 'text-sm text-yellow-600';
                        badge.className = 'px-3 py-1 bg-yellow-200 text-yellow-800 rounded-full text-sm';
                    } else {
                        problem.className = 'flex items-center justify-between p-4 bg-green-50 rounded-lg border-l-4 border-green-500';
                        problem.querySelector('.text-sm').className = 'text-sm text-green-600';
                        badge.className = 'px-3 py-1 bg-green-200 text-green-800 rounded-full text-sm';
                    }
                }
            });
        }
        
        function updateCoFiringSection() {
            // Co-firing Rate
            document.querySelectorAll('.bg-white.rounded-xl.card-shadow .text-2xl.text-green-600')[0]
                .textContent = dashboardData.co_firing_rate + '%';
            
            // Progress Bar
            document.querySelector('.bg-green-500.h-3.rounded-full').style.width = 
                dashboardData.co_firing_rate + '%';
            
            // Green MWh Values
            document.querySelectorAll('.bg-white.rounded-xl.card-shadow .text-2xl.text-green-600')[1]
                .textContent = dashboardData.green_mwh_last_week;
            document.querySelectorAll('.bg-white.rounded-xl.card-shadow .text-2xl.text-green-600')[2]
                .textContent = dashboardData.green_mwh_current_week;
            
            // SdoF Value
            document.querySelector('.text-2xl.font-bold.text-orange-600').textContent = 
                dashboardData.sdof + '%';
        }
        
        // 6. Chart Functions
        function initializeCharts() {
            // Production Chart
            const productionCtx = document.getElementById('productionChart').getContext('2d');
            charts.production = new Chart(productionCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: getProductionChartOptions()
            });
            
            // NCF Chart
            const ncfCtx = document.getElementById('ncfChart').getContext('2d');
            charts.ncf = new Chart(ncfCtx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: getNCFChartOptions()
            });
            
            // EAF vs EFOR Chart
            const eafEforCtx = document.getElementById('eafEforChart').getContext('2d');
            charts.eafEfor = new Chart(eafEforCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: getEAFEFORChartOptions()
            });
        }
        
        function updateCharts() {
            updateProductionChart();
            updateNCFChart();
            updateEAFEFORChart();
        }
        
        function updateProductionChart() {
            charts.production.data = {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7', 'Week 8'],
                datasets: [
                    {
                        label: 'Sebalang #1',
                        data: [
                            dashboardData.production_week1,
                            dashboardData.production_week2,
                            dashboardData.production_week3,
                            dashboardData.production_week4,
                            dashboardData.production_week5,
                            dashboardData.production_week6,
                            dashboardData.production_week7,
                            dashboardData.production_week8
                        ],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Sebalang #2',
                        data: [550, 580, 560, 590, 575, 600, 585, 610], // Example data
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'PLTG',
                        data: [320, 340, 315, 350, 330, 360, 345, 320], // Example data
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            };
            charts.production.update();
        }
        
        function updateNCFChart() {
            charts.ncf.data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [
                    {
                        label: 'Last Year',
                        data: [78, 82, 85, 88, 84, 86, 89, 91, 87, 85, 83, 80], // Example data
                        backgroundColor: 'rgba(107, 114, 128, 0.6)',
                        borderColor: '#6b7280',
                        borderWidth: 1
                    },
                    {
                        label: 'Current Year',
                        data: [80, 85, 88, 91, 87, 89, 92, 94, 90, 88, 86, 82], // Example data
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: '#6366f1',
                        borderWidth: 1
                    }
                ]
            };
            charts.ncf.update();
        }
        
        function updateEAFEFORChart() {
            charts.eafEfor.data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [
                    {
                        label: 'EAF (%)',
                        data: [92, 94, 96, 95, 93, 94, 95, 97, 94, 93, 92, 91], // Example data
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y'
                    },
                    {
                        label: 'EFOR (%)',
                        data: [3.2, 2.8, 2.1, 2.5, 3.1, 2.9, 2.3, 1.8, 2.6, 3.0, 3.4, 3.7], // Example data
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y1'
                    }
                ]
            };
            charts.eafEfor.update();
        }
        
        // 7. Chart Options (keep your original styling)
        function getProductionChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Weekly Production (MWh)' }
                },
                scales: { y: { beginAtZero: true, title: { display: true, text: 'MWh' } } }
            };
        }
        
        function getNCFChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Net Capacity Factor (%)' }
                },
                scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'NCF (%)' } } }
            };
        }
        
        function getEAFEFORChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'EAF (%)' },
                        min: 85,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'EFOR (%)' },
                        min: 0,
                        max: 5,
                        grid: { drawOnChartArea: false }
                    }
                }
            };
        }
        
        // 8. Initialization
        function init() {
            initializeCharts();
            fetchData();
            setInterval(fetchData, 300000); // Refresh every 5 minutes
            
            // Simulate real-time updates for power values
            setInterval(() => {
                const cards = [
                    { selector: '.border-green-500', key: 'sebalang1_output' },
                    { selector: '.border-blue-500', key: 'sebalang2_output' },
                    { selector: '.border-yellow-500', key: 'pltg_output' }
                ];
                
                cards.forEach(card => {
                    const element = document.querySelector(`${card.selector} .text-3xl`);
                    if (element) {
                        const currentValue = parseFloat(element.textContent);
                        const variation = (Math.random() - 0.5) * 2;
                        const newValue = Math.max(0, currentValue + variation);
                        element.textContent = newValue.toFixed(1) + ' MW';
                    }
                });
            }, 5000);
        }
        
        // Start the dashboard
        init();
    });
</script>
